# Badsender email builder

The badsender application is build around [Voidlabs' Mosaico mailing editor](https://github.com/voidlabs/mosaico)  
**Voidlabs' Mosaico** is a standalone front application build upon [Knockout](https://knockoutjs.com/)

The **Mosaico editor** is build around two main key concepts:

- **template:** an HTML file that will define any interactive blocks & their data representation
- **mailing:** a JSON object based on the template used

The **Badsender's backend** will:

- persist **templates** & **mailings**
- handle **users**
- handle rights to templates & mailings via the concept of **groups**
- handle **images storage**

The **Badsender's backend** is build upon [NuxtJS](https://nuxtjs.org/)/[VueJS](https://vuejs.org/), [ExpressJS](https://expressjs.com/) & [MongoDB](https://www.mongodb.com/)

![badsender architecture](./badsender-architecture.svg)

## files organization

### inherited folders & files from mosaico

| Name                             | mosaico's scope                      |
| -------------------------------- | ------------------------------------ |
| packages/editor/CONTRIBUTING.md  | contributing guidelines              |
| packages/editor/LICENSE          |                                      |
| packages/editor/NOTICE.txt       | editor dependencies license          |
| packages/editor/README.md        | original mosaicos's README           |
| packages/editor/appveyor.yml     |                                      |
| packages/editor/backend          | simple development backend           |
| res                              | editor statics                       |
| packages/editor/server-config.js | simple testing backend configuration |
| packages/editor/spec             | app test files                       |
| packages/editor/src              | front application source files       |
| packages/editor/templates        | mosaico's template                   |

### Express/Nuxt application

| Name                       | mosaico's scope                                                                                                                         |
| -------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| packages/server            | all the files for back server, scoped by domain (Express)                                                                               |
| packages/ui                | all the files for front (Nuxt)                                                                                                          |
| packages/documentation     | all documentation relative to Badsender's code                                                                                          |
| packages/documentation/api | API doc generated by [apiDoc](https://apidocjs.com/) with the command `build:api-documentation`                                         |
| gulpfile                   | build script replacement for the Grunfile.<br> This allowed us to fine-tune the build process without mangling with the original script |
| node.config.js             | all configuration variables (handled by [rc package](https://www.npmjs.com/package/rc))                                                 |
| nuxt.config.js             | The [nuxt configuration](https://nuxtjs.org/api/configuration-build)<br> use some variables of the node.config.js                       |
| .nvmrc                     | The [nvm (Node Version Manager)](https://github.com/nvm-sh/nvm) configuration file                                                      |
| Procfile                   | [Heroku file](https://devcenter.heroku.com/articles/procfile) to launch server process                                                  |

## API documentation

will be exposed on the route `/api/documentation`

## Editor's editable mobile preview

Mosaico give us the ability to preview a mobile template.  
It does that by rendering the HTML in a iFrame.

In order to enable it on the editable part we rely on some _hacks_:

- Mosaico add `.is-mobile-preview` or `.is-desktop-preview` classes to the `#page` in accordance to the preview button state
- Mosaico was modified to prevent the automatic `#main-wysiwyg-area` scoping to the template class if `#main-wysiwyg-area` is already found in the rule

  - the automatic style scoping prevent styles coming from the template to leak in the editor
  - this is not the case in the iFrame preview (already scoped by the iFrame)

In order to achieve a coherent rendering between the preview & the editable part you will need in your templates to:

- copy the content of your media queries
- duplicate them in class scoped by `.is-mobile-preview #main-wysiwyg-area` or `.is-desktop-preview #main-wysiwyg-area`

Those classes are not (yet) remove during download

## templates preview & block thumbs

### controlling the template display

From the [creator answer](https://github.com/voidlabs/mosaico/issues/246)

> […][data-ko-display](https://github.com/voidlabs/mosaico/wiki/Template-language#data-ko-attributes) will remove any `display: none` style from the element it is applied to. […] So your "html" can be opened in a browser and show you a correct version of your template […].
>
> **The "thumbnailer" task also add a `preview` class to the body of your template before previewing.** This means that you can even add custom CSS styles that will only be applied during the preview, e.g:
>
> ```html
> <style type="text/css" data-ko-remove>
>   .preview .block {
>     border: 3px solid red;
>   }
> </style>
> ```
>
> This style will be removed by mosaico, but will be used by the thumbnailer.

### on the server

just go on the template page & click on `generate preview`

### in local

mailing should be under the `/templates` folder

```
yarn thumbnail
```

thumbnails will be generated in the `edres` mailing folder
